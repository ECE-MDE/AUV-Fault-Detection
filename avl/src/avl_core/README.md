<div align="center">

# AVL Core Package
</div>

The `avl_core` package contains core AVL functionality such as the base node class, logging, utility function headers, and classes implementing the AVL binary communication protocol. All AVL packages use components from the `avl_core` package.

<br/><br/><br/>
<div align="center">

## Logging
</div>

Logging of messages and data is handled using a custom Logger class defined in the `logger.h` and `logger.cpp` files in the `avl_core` package. This class provides functions to log messages to either the console, a file, or both. If file logging is enabled, the log filepath can be specified. All log messages have the following format:

```
[timestamp] [level] [label] <message>
```
`timestamp` is the epoch time in seconds to 9 decimal points. `level` is the message's logging level abbreviation. `label` is the log label. The logging level and label are described in more detail below. The logging are shown in the following table, with DEBUG being the lowest level and ERROR being the highest level.

| Name | Abbreviation | Color | Description |
|:-|:-|:-|:-|
| DEBUG   | DBG | blue   | Low level information that is useful for debugging, but not needed for normal operation. |
| DATA    | DAT | gray   | Data from a sensor or other process. This is typically data you would want to plot. |
| INFO    | INF | green  | High level information such as status changes or progress that may be useful during operation. |
| WARNING | WRN | yellow | Warnings of potentially harmful or unintended situations that don't necessarily end operation. |
| ERROR   | ERR | red    | Severe error events that cannot be recovered from, ending operation. |

The log label represents the source of the log message, and is printed on every log message. It is used to differentiate the message source on the console when multiple nodes are logging to the console. The log label is typically set to the node name to indicate which node logged the message. If logging is done from a node derived from the node base class, the log label is automatically set to the node name.

The following image shows the appearance of each logging level in a colored console.


<div align="center">


<img src="https://ascl3.ece.vt.edu/avl/ros-packages/avl_core/-/raw/master/images/log_message_example.png" alt="Log message examples" width="70%" height="70%">
</div>







<br/><br/><br/>
<div align="center">

# Node Base Class
</div>

The node base class is implemented in the `node.h` file. This class implements the basic concept of an AVL node, built upon the concept of a ROS node. An AVL node is created by inheriting the node base class and implementing desired functionality. Functionality is defined by implementing the following three functions in the derived AVL node class:

* `void init()`: This function is called when the node first starts up. Any desired setup should be handled in this function. For example, opening a serial port and configuring a device could be placed in this function. What constitutes setup is up to the user.
* `void run()`: This function is called after the init function, and should contain the main functionality of the node after the init function handles any desired setup. For example, code to read data from a sensor and publish it could be placed in this function. Theoretically, all functionality could be placed in this function or the init function, but separation allows for more organized code.
* `void shutdown()`: This function is called after the run function returns, or when an unhandled exception is caught in the init or run functions. This function should contain any cleanup code, such as closing of files or ports.

If any of these functions are not implemented by the inheriting class, they will default to an empty function that does nothing. 

### Logging

All nodes also inherit the Logger class, meaning all logging functionality is available to the node. The log label for a log file generated by the node base class is automatically set to the node's name. Logging functionality may be configured using the ROS parameter server. The node base class will look for the following parameters in either the global namespace or node namespace:

| Parameter | Type | Default | Description |
|:-|:-|:-|:-|
| logging/console/enable      | `bool` | `true` | Enables or disables logging to the console. Will override all `logging/console/log_<level>` parameters. |
| logging/console/log_data    | `bool` | `true` | Enables or disables logging of messages with log level `DATA` to the console. |
| logging/console/log_debug   | `bool` | `true` | Enables or disables logging of messages with log level `DEBUG` to the console. |
| logging/console/log_info    | `bool` | `true` | Enables or disables logging of messages with log level `INFO` to the console. |
| logging/console/log_warning | `bool` | `true` | Enables or disables logging of messages with log level `WARNING` to the console. |
| logging/console/log_error   | `bool` | `true` | Enables or disables logging of messages with log level `ERROR` to the console. |
| logging/file/enable         | `bool` | `true` | Enables or disables logging to `/var/avl_logs/current/`. Will override all `logging/file/log_<level>` parameters. |
| logging/file/log_data       | `bool` | `true` | Enables or disables logging of messages with log level `DATA` to file. |
| logging/file/log_debug      | `bool` | `true` | Enables or disables logging of messages with log level `DEBUG` to file. |
| logging/file/log_info       | `bool` | `true` | Enables or disables logging of messages with log level `INFO` to file. |
| logging/file/log_warning    | `bool` | `true` | Enables or disables logging of messages with log level `WARNING` to file. |
| logging/file/log_error      | `bool` | `true` | Enables or disables logging of messages with log level `ERROR` to file. |

Logging parameters in the node namespace will override logging parameters in the global namespace.

### Example Usage

An example AVL node using the node base class is given in the `avl_core` package under the file names `example_node.cpp` and `example_node.config`. These files demonstrate basic construction of a node, including inheritance of the node base class and definition of the init, run, and shutdown functions. The following two aspects of the example node are important to note. 

First, all derived nodes must have the following constructor signature so that all command line arguments are correctly passed to the ROS node.

```c++
ExampleNode(int argc, char **argv) : Node(argc, argv) { }
```

Second, the following main function must be located at the end of every derived node class file in order to run the node. The main function simply instantiates the node, passes it the command line arguments, and starts the node.

```c++
//==============================================================================
//                                  MAIN
//==============================================================================
int main(int argc, char **argv)
{
    ExampleNode node(argc, argv);
    node.start();
    return 0;
}
```

In both of these examples, `ExampleNode` is replaced with the name of your derived node class.

<br/><br/><br/>
<div align="center">

## AVL Binary Communication Protocol
</div>

The `avl_core` package provides the `avl::Packet` and `avl::Field` classes implementing the AVL binary communication protocol as documented in the frontseat driver ICD. Classes derived from the `avl::Packet` base class are also provided for each packet type defined in the ICD. These classes can be included with `#include <avl_core/protocol/avl.h>`.

<br/><br/><br/>
<div align="center">

## Utility Function Headers
</div>

The `avl_core` package provides various utility functions for math, vector and string manipulation, and other common operations in the `include/util` folder. These utility function headers can be included as need in other projects.
